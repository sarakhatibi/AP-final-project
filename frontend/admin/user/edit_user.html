<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ویرایش پروفایل</title>
  <style>
   body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(to left, #fdf6ef, #e6f4ee);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      direction: rtl;
      margin: 0;
   }
    .container {
      background-color: #ffffff;
      padding: 35px 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(125, 174, 160, 0.3);
      max-width: 500px;
      width: 100%;
    }
    h2 {
      text-align: center;
      color: #2e6651;
      font-size: 26px;
      margin-bottom: 25px;
    }
    label, input, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
    }
    input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #89b9a6;
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
  }
    button:hover {
      background-color: #74ab94;
      transform: translateY(-2px);
   }
    #response {
      white-space: pre-wrap;
      margin-top: 20px;
      background-color: #f2f2f2;
      padding: 15px;
      border-radius: 10px;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ویرایش پروفایل</h2>
    <form id="editProfileForm">
      <label for="full_name">نام کامل</label>
      <input type="text" id="full_name" required />

      <label for="username">نام کاربری</label>
      <input type="text" id="username" required />

      <label for="email">ایمیل</label>
      <input type="email" id="email" required />

      <label for="password">رمز عبور جدید (اختیاری)</label>
      <input type="password" id="password" />

      <button type="submit">ثبت تغییرات</button>
    </form>
    <div id="response"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");

    const setResponse = (msg, type = "info") => {
      const resDiv = document.getElementById("response");
      resDiv.textContent = msg;
      resDiv.style.color = type === "error" ? "red" : "#2e6651";
    };

    if (!token || token.length < 10) {
      setResponse("❌ لطفاً ابتدا وارد شوید", "error");
      document.getElementById("editProfileForm").style.display = "none";
    } else {
      fetch("http://localhost:8000/users/edit", {
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(err => {
            throw new Error(err.detail || "خطا در دریافت اطلاعات کاربر");
          });
        }
        return res.json();
      })
      .then(data => {
        document.getElementById("full_name").value = data.full_name;
        document.getElementById("username").value = data.username;
        document.getElementById("email").value = data.email;
      })
      .catch(err => setResponse("⚠️ " + err.message, "error"));
    }

    document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const full_name = document.getElementById("full_name").value.trim();
      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const payload = { full_name, username, email };
      if (password) payload.password = password;

      setResponse("⏳ در حال ارسال...");
      try {
        const res = await fetch("http://localhost:8000/users/edit", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || result.message || "خطا در ویرایش");

        setResponse(result.msg || "✅ اطلاعات با موفقیت ویرایش شد");
      } catch (err) {
        setResponse("❌ " + err.message, "error");
      }
    });
  </script>
</body>
</html>